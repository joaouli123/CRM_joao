orrigir o problema de duplicaÃ§Ã£o de mensagens e garantir que o status de "enviado", "recebido", "entregue" e "falha" seja atualizado corretamente. AlÃ©m disso, precisamos garantir que o status de "mensagem recebida" funcione, atualizando os Ã­cones corretamente para cada mensagem.
Problemas identificados:

    DuplicaÃ§Ã£o de mensagens:

        As mensagens estÃ£o sendo duplicadas, porque o sistema nÃ£o estÃ¡ verificando corretamente se uma mensagem jÃ¡ foi recebida ou enviada anteriormente.

    NÃ£o validaÃ§Ã£o de "Mensagem Recebida":

        O sistema nÃ£o estÃ¡ atualizando o status corretamente para "mensagem recebida", ou seja, ele nÃ£o marca uma mensagem como "entregue" no frontend.

    Status incorreto:

        O status das mensagens nÃ£o estÃ¡ sendo alterado conforme a interaÃ§Ã£o (e.g., "â³" â†’ "âœ“" â†’ "âœ”âœ”").

Passos para CorreÃ§Ã£o:

    CorreÃ§Ã£o de DuplicaÃ§Ã£o de Mensagens:

        Ao receber uma mensagem, verifique se ela jÃ¡ foi enviada ou jÃ¡ existe (utilizando o tempId ou id).

        Se a mensagem jÃ¡ existir, ignore a duplicaÃ§Ã£o, caso contrÃ¡rio, adicione a nova mensagem.

    Validar "Mensagem Recebida":

        Certifique-se de que o sistema nÃ£o sÃ³ marque a mensagem como "enviada" (com sent), mas tambÃ©m ao receber a confirmaÃ§Ã£o do servidor, marque a mensagem como "recebida" (e possivelmente "entregue").

        Ao receber a confirmaÃ§Ã£o de entrega, atualize a mensagem para o status "entregue" (representado com âœ”âœ”).

    SubstituiÃ§Ã£o de Mensagens TemporÃ¡rias:

        Ao receber uma confirmaÃ§Ã£o do servidor (como um messageSent ou messageReceived via WebSocket), substitua a mensagem temporÃ¡ria (tempId) pela mensagem final e atualize o status para "sent", "delivered" ou "failed".

    CorreÃ§Ã£o do Status Visual:

        Use o status de mensagem para indicar:

            â³: Mensagem sendo enviada (status "pending").

            âœ“: Mensagem enviada com sucesso (status "sent").

            âœ”âœ”: Mensagem entregue (status "delivered").

            âŒ: Erro ao enviar (status "failed").

CÃ³digo a ser alterado:

    Verificar DuplicaÃ§Ã£o de Mensagens (via tempId ou id):
    No evento onmessage, dentro da verificaÃ§Ã£o do WebSocket:

        Adicionar VerificaÃ§Ã£o para DuplicaÃ§Ã£o:
        Ao processar as mensagens recebidas via WebSocket:

    // Verificar duplicaÃ§Ã£o por tempId e id
    const existsById = prev.some((m: any) => m.id === msgData.id || m.tempId === msgData.tempId);
    if (existsById) {
      console.log(`âš ï¸ Mensagem ${msgData.id || msgData.tempId} JÃ EXISTE, ignorando duplicaÃ§Ã£o`);
      return prev;
    }

SubstituiÃ§Ã£o de Mensagens TemporÃ¡rias:
Quando uma mensagem temporÃ¡ria for recebida e confirmada pelo servidor:

    AtualizaÃ§Ã£o do Status da Mensagem:

    if (msgData.direction === 'sent' && msgData.id) {
      console.log(`ğŸ” BUSCANDO mensagem temporÃ¡ria para "${msgData.content}" | tempId: ${msgData.tempId}`);
      
      let tempIndex = prev.findIndex((m: any) => m.tempId === msgData.tempId);
      if (tempIndex !== -1) {
        const newMessages = [...prev];
        newMessages[tempIndex] = {
          id: msgData.id,
          content: msgData.content,
          phoneNumber: msgData.phoneNumber,
          direction: msgData.direction,
          timestamp: new Date(msgData.timestamp),
          status: 'sent',
          tempId: undefined // Remover tempId apÃ³s a confirmaÃ§Ã£o
        };
        return newMessages;
      }
    }

AtualizaÃ§Ã£o de Status de Entrega ("âœ”âœ”"):
Ao receber a confirmaÃ§Ã£o de entrega, altere o status para "entregue" (âœ”âœ”):

    Status de Entrega:

    if (data.type === 'messageReceived' && data.data) {
      const msgData = data.data;
      setRealtimeMessages((prev) => 
        prev.map((msg) => 
          msg.id === msgData.id 
            ? { ...msg, status: 'delivered' } // Atualizar para 'delivered' quando a mensagem for entregue
            : msg
        )
      );
    }

Adicionar o Indicador de Status Visual:
Ao exibir as mensagens, implemente o indicador visual com base no status:

    Status de Envio e Recebimento:

        <span className="text-xs ml-1">
          {message.status === 'pending' && 'â³'}
          {message.status === 'sent' && 'âœ“'}
          {message.status === 'delivered' && 'âœ”âœ”'}
          {message.status === 'failed' && 'âŒ'}
        </span>

ConsideraÃ§Ãµes Finais:

    VerificaÃ§Ã£o Adicional:

        Sempre que uma mensagem for recebida e nÃ£o encontrar uma correspondÃªncia para tempId, adicione-a como uma nova mensagem com o status apropriado (por exemplo, "sent" ou "received").

    ConfirmaÃ§Ãµes de Mensagens:

        Certifique-se de que o servidor estÃ¡ enviando corretamente os eventos de messageSent e messageReceived via WebSocket. Esses eventos sÃ£o cruciais para garantir que a substituiÃ§Ã£o das mensagens temporÃ¡rias e o status de "entregue" sejam atualizados corretamente.

    OtimizaÃ§Ã£o e Performance:

        Verifique o uso de Map para evitar problemas de duplicaÃ§Ã£o em grandes quantidades de mensagens e melhorar a performance.

Testes a serem realizados:

    Envie uma mensagem e verifique se ela aparece imediatamente com o status â³.

    ApÃ³s o envio, verifique se ela Ã© atualizada para âœ“ quando enviada e, em seguida, para âœ”âœ” quando entregue.

    Tente enviar uma mensagem e veja se o WebSocket processa corretamente as mensagens temporÃ¡rias.

    Verifique se as mensagens nÃ£o estÃ£o sendo duplicadas apÃ³s o envio e a confirmaÃ§Ã£o de entrega.

Se vocÃª seguir essas sugestÃµes de correÃ§Ã£o, o sistema de mensagens em tempo real e o gerenciamento de duplicaÃ§Ãµes devem funcionar corretamente, com os Ã­cones de status de envio e entrega funcionando como esperado.